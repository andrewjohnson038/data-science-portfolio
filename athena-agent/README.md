# AWS Athena AI Agent

A Streamlit-based AI agent interface that allows users to query AWS Athena databases using natural language. The agent uses AWS Bedrock for secure, enterprise-level AI interactions and converts natural language questions into SQL queries, executes them against Athena, and provides results with visualizations.

## Features

- **Natural Language Interface**: Ask questions about your data in plain English
- **AWS Bedrock Integration**: Enterprise-grade AI using Meta's Llama 3.1 70B model
- **Real-time Query Execution**: Direct integration with AWS Athena
- **Interactive Visualizations**: Automatic chart generation based on query results
- **SQL Transparency**: View the exact SQL queries generated by the AI
- **Secure Enterprise Setup**: Proper IAM configurations and AWS best practices

## Prerequisites

### AWS Account Setup
1. **AWS Account**: Active AWS account with appropriate permissions
2. **AWS CLI**: Install and configure AWS CLI (Optional, reduces boto3 config)
3. **Python 3.8+**: Required for running the application

### Required AWS Services
- **AWS Bedrock**: For AI model access
- **AWS Athena**: For data querying
- **Amazon S3**: For Athena query results and data storage
- **IAM**: For secure access management

## Installation

### 1. Clone the Repository
```bash
git clone <your-repo-url>
cd athena-agent
```

### 2. Install Dependencies
```bash
pip install streamlit boto3 pandas plotly
```

### 3. Configure AWS Credentials
```bash
aws configure
```
Enter your AWS Access Key ID, Secret Access Key, default region, and output format.

## IAM Configuration

### Required IAM Permissions

Create an IAM user or role with the following permissions:

#### Bedrock Permissions
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "bedrock:InvokeModel",
                "bedrock:InvokeModelWithResponseStream"
            ],
            "Resource": "arn:aws:bedrock:*:*:model/meta.llama3-70b-instruct-v1:0"
        }
    ]
}
```

#### Athena Permissions
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "athena:StartQueryExecution",
                "athena:GetQueryExecution",
                "athena:GetQueryResults",
                "athena:GetWorkGroup",
                "athena:ListWorkGroups",
                "athena:ListDataCatalogs",
                "athena:ListDatabases",
                "athena:ListTableMetadata"
            ],
            "Resource": "*"
        }
    ]
}
```

#### S3 Permissions
```json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:ListBucket",
                "s3:DeleteObject"
            ],
            "Resource": [
                "arn:aws:s3:::your-athena-results-bucket",
                "arn:aws:s3:::your-athena-results-bucket/*",
                "arn:aws:s3:::your-data-bucket",
                "arn:aws:s3:::your-data-bucket/*"
            ]
        }
    ]
}
```
Or add these roles directly in IAM manager to the user (you may need more permissions assigned depending on the tasks of the user profile):

- AmazonBedrockFullAccess
- AmazonAthenaFullAccess
- AmazonS3FullAccess

### IAM User Setup Steps

1. **Create IAM User**:
   ```bash
   aws iam create-user --user-name athena-agent-user
   ```

2. **Create Access Keys**:
   ```bash
   aws iam create-access-key --user-name athena-agent-user
   ```

3. **Attach Policies**:
   ```bash
   aws iam attach-user-policy --user-name athena-agent-user --policy-arn arn:aws:iam::aws:policy/AmazonBedrockFullAccess
   aws iam attach-user-policy --user-name athena-agent-user --policy-arn arn:aws:iam::aws:policy/AmazonAthenaFullAccess
   aws iam attach-user-policy --user-name athena-agent-user --policy-arn arn:aws:iam::aws:policy/AmazonS3FullAccess
   ```

4. **Create Custom Policy** (for more restrictive access):
   - Use the JSON policies above to create custom policies
   - Attach them to your IAM user

## Configuration

### 1. AWS Bedrock Model Access

Before using the application, you must request access to the Bedrock model:

1. Go to [AWS Bedrock Console](https://console.aws.amazon.com/bedrock/)
2. Navigate to "Model access" in the left sidebar
3. Click "Request model access"
4. Find "Meta" section and check "Llama 3.1 70B Instruct"
5. Click "Request model access"
6. Wait for approval (usually instant)

### 2. Update Configuration

Edit `config.py` with your specific settings:

```python
# AWS Configuration
AWS_ACCESS_KEY_ID = "your-access-key-id"
AWS_SECRET_ACCESS_KEY = "your-secret-access-key"
AWS_REGION = "us-east-1"  # or your preferred region

# Athena Configuration
ATHENA_DATABASE = "your-database-name"
ATHENA_S3_OUTPUT_LOCATION = "s3://your-bucket/athena-results/"
ATHENA_WORKGROUP = "primary"

# Bedrock Model
BEDROCK_MODEL_ID = "meta.llama3-70b-instruct-v1:0"
```

### 3. Streamlit Secrets (Alternative to config.py)

Create `.streamlit/secrets.toml`:

```toml
AWS_ACCESS_KEY_ID = "your-access-key-id"
AWS_SECRET_ACCESS_KEY = "your-secret-access-key"
AWS_REGION = "us-east-1"
```

## Database Setup

### 1. Create S3 Buckets

```bash
# Create bucket for Athena results
aws s3 mb s3://your-athena-results-bucket

# Create bucket for your data (if not already exists)
aws s3 mb s3://your-data-bucket
```

### 2. Create Athena Database

```sql
CREATE DATABASE your_database_name;
```

### 3. Load Sample Data (Optional)

The project includes sample data generation and CSV to Athena conversion:

```bash
# Generate sample data
python gen_fake_data.py

# Convert CSV files to Athena tables
python csv_to_athena.py
```

## Running the Application

### Start the Streamlit App
```bash
streamlit run main.py
```

The application will be available at `http://localhost:8501`

## Usage Examples

### Sample Questions You Can Ask

1. **Sales Analysis**:
   - "Show me top 5 users by sales in June"
   - "What's the total sales amount for Software products?"
   - "Compare sales between June and July 2025"

2. **User Insights**:
   - "How many users signed up in July?"
   - "Show me users from the United States"
   - "Which users have the highest contract values?"

3. **Financial Analysis**:
   - "What's the average invoice amount?"
   - "Show me unpaid invoices"
   - "Calculate total contract value by contract type"

### Expected Response Format

The agent will provide:
- **Natural language response** with insights
- **SQL query used** (expandable section)
- **Data visualization** (automatic chart generation)
- **Raw data table** (downloadable)

## Troubleshooting

### Common Issues

1. **Bedrock Access Denied**:
   - Ensure model access is granted in Bedrock console
   - Verify IAM permissions include Bedrock access

2. **Athena Query Errors**:
   - Check database and table names in config
   - Verify S3 bucket permissions
   - Ensure Athena workgroup exists

3. **S3 Access Issues**:
   - Verify bucket names in configuration
   - Check IAM permissions for S3 access
   - Ensure buckets exist in the specified region

### Debug Mode

Use the debug utilities for troubleshooting:

```bash
# Test Bedrock connection
python bedrock_test.py

# Test Athena connection
python debug_athena.py
```

## Project Structure

```
athena-agent/
├── main.py                 # Streamlit app entry point
├── home_pg.py             # Main Streamlit interface
├── athena_agent.py        # Core AI agent logic
├── config.py              # Configuration settings
├── csv_to_athena.py       # CSV to Athena conversion utility
├── gen_fake_data.py       # Sample data generator
├── bedrock_test.py        # Bedrock connection test
├── debug_athena.py        # Athena connection test
├── dummy_data/            # Sample CSV files
│   ├── users.csv
│   ├── sales.csv
│   ├── contracts.csv
│   └── invoices.csv
└── .streamlit/            # Streamlit configuration
    └── secrets.toml       # AWS credentials (optional)
```

## Security Best Practices

1. **Use IAM Roles** instead of access keys when possible
2. **Rotate access keys** regularly
3. **Use least privilege** principle for IAM permissions
4. **Enable CloudTrail** for audit logging
5. **Use VPC endpoints** for private network access
6. **Encrypt data** in S3 buckets

## Performance Optimization

1. **Query Optimization**:
   - Use appropriate WHERE clauses
   - Limit result sets with LIMIT
   - Use table partitioning for large datasets

2. **Cost Optimization**:
   - Monitor Athena query costs
   - Use appropriate S3 storage classes
   - Implement query result caching

## Contributing

1. Fork the repository
2. Create a feature branch
3. Make your changes
4. Add tests if applicable
5. Submit a pull request

## License

This project is licensed under the MIT License - see the LICENSE file for details.

## Support

For issues and questions:
1. Check the troubleshooting section
2. Review AWS documentation
3. Open an issue in the repository

## Version History

- **v1.0.0**: Initial release with Bedrock and Athena integration
- **v1.1.0**: Added visualization capabilities
- **v1.2.0**: Enhanced error handling and debugging tools 
